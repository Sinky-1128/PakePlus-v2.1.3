<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="小学生计算题随机生成器 - 支持整数、小数、分数运算，提供多种题型和难度选择">
    <meta name="keywords" content="小学数学,计算题,习题生成,练习题,数学工具">
    <title>小学生计算题随机生成器</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --warning-color: #f39c12;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', Arial, Helvetica, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.4;
            padding: 5px 10px 10px; /* 标题内边距 */
        }

        .container {
            max-width: 1200px; /* 从1400px改为1200px */
            margin: 0 auto;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            padding: 10px 20px; /* 减少上下内边距，从20px改为10px */
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .description {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* 计时器样式 - 固定在页面右上角 */
        .timer-container {
            position: fixed;
            top: 15px;
            right: 15px;
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            min-width: 120px;
            z-index: 1000;
            border: 2px solid var(--primary-color);
        }
        
        .timer-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
            line-height: 1.2;
        }
        
        .timer-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .timer-btn {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            flex: 1;
        }
        
        .timer-btn:hover {
            background-color: #2980b9;
        }
        
        .timer-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .timer-inputs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            justify-content: center;
        }
        
        .timer-input {
            width: 60px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .timer-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }
        
        .timer-section {
            margin-bottom: 10px;
        }
        
        .warning {
            color: var(--warning-color);
        }
        
        .danger {
            color: var(--accent-color);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* 其他原有样式保持不变 */
        .control-panel {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 25px;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group-wide {
            flex: 1;
            min-width: 300px;
        }

        label {
            margin-bottom: 8px;
            font-weight: 600;
        }

        input[type="number"] {
            width: 120px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        input[type="number"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .operations {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .operation-btn {
            position: relative;
            padding: 10px 20px;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.1rem;
        }

        .operation-btn:hover {
            background-color: #e0e0e0;
        }

        .operation-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .operation-btn.selected::after {
            content: "✓";
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--secondary-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .number-type-options, .decimal-options, .fraction-options, .problem-type-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .option-btn {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .option-btn.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .actions-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 15px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 50px;
            flex: 1;
            min-width: 140px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-success {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-danger {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .result-area {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            display: none;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .result-title {
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .result-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .problems-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .problem-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .section-problems {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        /* 基本运算 - 一行4个题目 */
        .basic-operation-section .section-problems {
            grid-template-columns: repeat(4, 1fr);
        }

        /* 高级运算 - 一行3个题目 */
        .advanced-operation-section .section-problems {
            grid-template-columns: repeat(3, 1fr);
        }

        @media (max-width: 1300px) {
            .section-problems {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .basic-operation-section .section-problems {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .advanced-operation-section .section-problems {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1000px) {
            .section-problems {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .basic-operation-section .section-problems {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .advanced-operation-section .section-problems {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 800px) {
            .section-problems {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .basic-operation-section .section-problems,
            .advanced-operation-section .section-problems {
                grid-template-columns: 1fr;
            }
            
            /* 在小屏幕上调整计时器位置和大小 */
            .timer-container {
                top: 10px;
                right: 10px;
                min-width: 150px;
                padding: 15px;
            }
            
            .timer-display {
                font-size: 2rem;
            }
        }

        @media (max-width: 600px) {
            .section-problems {
                grid-template-columns: 1fr;
            }
            
            .timer-container {
                position: relative;
                top: auto;
                right: auto;
                margin: 0 auto 20px;
                width: 100%;
                max-width: 300px;
            }
        }

        .problem {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            background-color: #fafafa;
            display: flex;
            align-items: flex-end;
            transition: var(--transition);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }

        /* 添加垂直虚线分隔线 */
        .basic-operation-section .problem {
            position: relative;
        }
        
        .basic-operation-section .problem:not(:nth-child(4n))::after {
            content: "";
            position: absolute;
            right: -10px;
            top: 10%;
            height: 80%;
            border-right: 1px dashed #ccc;
        }

        .advanced-operation-section .problem {
            position: relative;
        }
        
        .advanced-operation-section .problem:not(:nth-child(3n))::after {
            content: "";
            position: absolute;
            right: -10px;
            top: 10%;
            height: 80%;
            border-right: 1px dashed #ccc;
        }

        .problem:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .problem-text {
            font-size: 1.2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            width: 100%;
            line-height: 1.5; /* 默认行高 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 当题目需要换行时，使用双倍行距 */
        .problem.multiline .problem-text {
            line-height: 2;
            white-space: normal;
            overflow: visible;
            text-overflow: unset;
        }

        .answer {
            display: none;
            color: #000000;
            font-weight: 600;
        }

        .answer-visible .answer {
            display: inline;
        }

        .answer-visible .blank {
            display: none;
        }

        .blank {
            display: inline-block;
            width: 50px;
            border-bottom: 2px solid #ccc;
            margin: 0 5px;
            vertical-align: bottom;
        }

        /* 填空题括号样式 */
        .fill-blank {
            display: inline-block;
            width: 60px;
            text-align: center;
            margin: 0 5px;
            border-bottom: 2px solid #ccc;
            vertical-align: bottom;
            height: 1.5em;
        }

        /* 分数样式改进 */
        .fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 2px;
        }

        .fraction .numerator, .fraction .denominator {
            line-height: 1;
            padding: 0 3px;
        }

        .fraction .numerator {
            border-bottom: 1px solid;
            padding-bottom: 1px;
        }

        .fraction .denominator {
            padding-top: 1px;
        }

        /* 运算符与分数对齐 */
        .problem-text {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }

        /* 答案下划线不对齐 */
        .blank, .fill-blank {
            vertical-align: baseline;
        }

        .message {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }

        .message-success {
            background-color: rgba(46, 204, 113, 0.2);
            color: #27ae60;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .message-error {
            background-color: rgba(231, 76, 60, 0.2);
            color: #c0392b;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .message-warning {
            background-color: rgba(243, 156, 18, 0.2);
            color: #d35400;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }

        .flash {
            animation: flash 0.5s ease;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }

        /* 使用说明样式 */
        .instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .instructions h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .instructions ul {
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        /* 打印样式 */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
                font-size: 14pt;
                line-height: 1.2;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .control-panel,
            .result-header,
            .message,
            .no-print,
            .stats,
            header,
            .instructions,
            .timer-container {
                display: none !important;
            }
            
            .result-area {
                display: block !important;
                box-shadow: none;
                padding: 0;
                margin: 0;
                width: 100%;
            }
            
            /* 打印标题样式 */
            .print-title {
                display: block !important;
                text-align: center;
                font-size: 16pt;
                margin-bottom: 15px;
                font-weight: bold;
                page-break-after: avoid;
            }
            
            /* 基本运算 - 一行4个题目 */
            .basic-operation-section .section-problems {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 10px !important;
            }
            
            /* 高级运算 - 一行3个题目 */
            .advanced-operation-section .section-problems {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 10px !important;
            }
            
            /* 确保题型之间不会强制换页 */
            .problem-section {
                page-break-inside: avoid;
                break-inside: avoid;
                margin-bottom: 15px !important;
                page-break-before: auto !important;
            }
            
            /* 删除题型标题 */
            .section-title {
                display: none !important;
            }
            
            /* 打印时的问题样式 - 无边框，纯文本 */
            .problem {
                border: none !important;
                background-color: transparent !important;
                padding: 5px 0 !important;
                margin: 0 !important;
                display: block !important;
                page-break-inside: avoid;
                break-inside: avoid;
                align-items: flex-end !important;
                white-space: nowrap !important;
                overflow: visible !important;
                position: relative;
            }
            
            /* 打印时的垂直虚线分隔线 */
            .basic-operation-section .problem:not(:nth-child(4n))::after {
                content: "";
                position: absolute;
                right: -5px;
                top: 10%;
                height: 80%;
                border-right: 1px dashed #ccc;
            }

            .advanced-operation-section .problem:not(:nth-child(3n))::after {
                content: "";
                position: absolute;
                right: -5px;
                top: 10%;
                height: 80%;
                border-right: 1px dashed #ccc;
            }
            
            .problem-text {
                font-size: 12pt;
                text-align: left;
                margin: 0;
                justify-content: flex-start;
                align-items: flex-end !important;
                white-space: nowrap !important;
            }
            
            /* 打印时的多行题目 */
            .problem.multiline .problem-text {
                line-height: 2;
                white-space: normal;
            }
            
            .blank {
                display: inline-block;
                width: 30px;
                border-bottom: 1px solid #000;
                margin: 0 3px;
                vertical-align: bottom;
            }

            .fill-blank {
                display: inline-block;
                width: 40px;
                text-align: center;
                margin: 0 3px;
                border-bottom: 1px solid #000;
                vertical-align: bottom;
                height: 1.5em;
            }
            
            /* 打印答案时的样式 */
            .print-answers .answer {
                display: inline !important;
                font-weight: bold;
                color: #000000 !important;
            }
            
            .print-answers .blank,
            .print-answers .fill-blank {
                display: none !important;
            }
            
            /* 确保在一页内打印 */
            .problems-container {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }

        .hidden {
            display: none;
        }
        
        /* 数值范围输入框样式 */
        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .range-inputs input {
            width: 120px;
        }
        
        .range-inputs span {
            font-weight: bold;
        }
        
        /* 小数位数选择 */
        .decimal-digits {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .digit-btn {
            padding: 8px 15px;
            background-color: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .digit-btn.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        /* 新样式：合并运算按钮组 */
        .operations-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            width: 100%;
        }
        
        .basic-operations, .advanced-operations {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        
        /* 新样式：数字个数与高级运算按钮对齐 */
        .number-count-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: auto;
        }
        
        .number-count-container label {
            margin-bottom: 0;
            white-space: nowrap;
        }
        
        .number-count-container select {
            width: 50px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        /* 新样式：小数范围与小数位数在同一行 */
        .decimal-settings-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }
        
        .decimal-range-group {
            display: flex;
            flex-direction: column;
        }
        
        .decimal-digits-group {
            display: flex;
            flex-direction: column;
        }
        
        .decimal-digits-group label {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <!-- 计时器 - 现在放在body内，与container同级 -->
    <div class="timer-container no-print">
        <div class="timer-section">
            <div class="timer-inputs">
                <div>
                    <input type="number" id="timerHours" class="timer-input" min="0" max="23" value="0">
                    <div class="timer-label">时</div>
                </div>
                <div>
                    <input type="number" id="timerMinutes" class="timer-input" min="0" max="59" value="15">
                    <div class="timer-label">分</div>
                </div>
                <div>
                    <input type="number" id="timerSeconds" class="timer-input" min="0" max="59" value="0">
                    <div class="timer-label">秒</div>
                </div>
            </div>
        </div>
        <div class="timer-display" id="timerDisplay">15:00</div>
        <div class="timer-controls">
            <button class="timer-btn" id="startTimer">开始</button>
            <button class="timer-btn" id="pauseTimer" disabled>暂停</button>
            <button class="timer-btn" id="resetTimer">重置</button>
        </div>
    </div>
    
    <div class="container">
        <header>
            <h1>小学生计算题随机生成器</h1>
            <p class="description">一键生成自定义范围的计算题，支持整数、小数、分数运算</p>
        </header>
        
        <main class="control-panel">
            <div class="settings-row">
                <div class="form-group">
                    <label for="numberType">数值类型</label>
                    <div class="number-type-options">
                        <div class="option-btn selected" data-type="integer" aria-label="选择整数类型">整数</div>
                        <div class="option-btn" data-type="decimal" aria-label="选择小数类型">小数</div>
                        <div class="option-btn" data-type="fraction" aria-label="选择分数类型">分数</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="problemType">题目类型</label>
                    <div class="problem-type-options">
                        <div class="option-btn selected" data-problem-type="calculation" aria-label="选择计算题型">计算题</div>
                        <div class="option-btn" data-problem-type="fill-blank" aria-label="选择填空题型">填空题</div>
                        <div class="option-btn" data-problem-type="comparison" aria-label="选择比较大小题型">比较大小</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="problemCount">题目数量</label>
                    <input type="number" id="problemCount" min="1" max="200" value="100" aria-label="设置题目数量">
                </div>
            </div>
            
            <div class="settings-row">
                <!-- 整数范围输入 -->
                <div class="form-group" id="integerRange">
                    <label for="intMin">整数范围 (1-999)</label>
                    <div class="range-inputs">
                        <input type="number" id="intMin" min="1" max="999" value="1" aria-label="整数最小值">
                        <span>到</span>
                        <input type="number" id="intMax" min="1" max="999" value="100" aria-label="整数最大值">
                    </div>
                </div>
                
                <!-- 小数范围输入 -->
                <div class="form-group hidden" id="decimalRange">
                    <div class="decimal-settings-row">
                        <div class="decimal-range-group">
                            <label for="decMin">小数范围 (1-999)</label>
                            <div class="range-inputs">
                                <input type="number" id="decMin" min="1" max="999" step="1" value="1" aria-label="小数最小值">
                                <span>到</span>
                                <input type="number" id="decMax" min="1" max="999" step="1" value="100" aria-label="小数最大值">
                            </div>
                        </div>
                        
                        <div class="decimal-digits-group">
                            <label for="decimalDigits">小数位数</label>
                            <div class="decimal-digits">
                                <div class="digit-btn selected" data-digits="1" aria-label="选择1位小数">1位小数</div>
                                <div class="digit-btn" data-digits="2" aria-label="选择2位小数">2位小数</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 分数范围输入 -->
                <div class="form-group hidden" id="fractionRange">
                    <label for="fracNumMin">分数范围 (分子分母1-999)</label>
                    <div class="range-inputs">
                        <div>
                            <span>分子</span>
                            <input type="number" id="fracNumMin" min="1" max="999" value="1" aria-label="分子最小值">
                            <span>到</span>
                            <input type="number" id="fracNumMax" min="1" max="999" value="100" aria-label="分子最大值">
                        </div>
                        <div>
                            <span>分母</span>
                            <input type="number" id="fracDenMin" min="1" max="999" value="1" aria-label="分母最小值">
                            <span>到</span>
                            <input type="number" id="fracDenMax" min="1" max="999" value="100" aria-label="分母最大值">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 合并运算按钮组 -->
            <div class="settings-row">
                <div class="form-group form-group-wide">
                    <div class="operations-container">
                        <div class="basic-operations">
                            <div class="operation-btn selected" data-operation="+" aria-label="选择加法运算">加法</div>
                            <div class="operation-btn selected" data-operation="-" aria-label="选择减法运算">减法</div>
                            <div class="operation-btn" data-operation="×" aria-label="选择乘法运算">乘法</div>
                            <div class="operation-btn" data-operation="÷" aria-label="选择除法运算">除法</div>
                        </div>
                        
                        <div class="advanced-operations">
                            <div class="operation-btn" data-operation="continuous" aria-label="选择连加连减运算">连加连减</div>
                            <div class="operation-btn" data-operation="mixed" aria-label="选择加减混合运算">加减混合</div>
                            <div class="operation-btn" data-operation="continuous-mul-div" aria-label="选择连乘连除运算">连乘连除</div>
                            <div class="operation-btn" data-operation="mixed-mul-div" aria-label="选择乘除混合运算">乘除混合</div>
                            <div class="operation-btn" data-operation="all-mixed" aria-label="选择加减乘除混合运算">加减乘除混合</div>
                        </div>
                        
                        <div class="number-count-container">
                            <label for="numberCount">数字个数</label>
                            <select id="numberCount" aria-label="选择数字个数">
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="actions-row">
                <button class="btn btn-primary" id="generateBtn" aria-label="生成计算题">
                    <span>立即生成</span>
                </button>
                <button class="btn btn-primary no-print" id="printQuestionsBtn" aria-label="打印试卷">
                    <span>打印试卷</span>
                </button>
                <button class="btn btn-danger no-print" id="printAnswersBtn" aria-label="打印答案">
                    <span>打印答案</span>
                </button>
                <button class="btn btn-warning no-print" id="clearAllBtn" aria-label="清空所有题目">
                    <span>清空题目</span>
                </button>
            </div>
            
            <div class="message message-success" id="successMessage">
                计算题已成功生成！
            </div>
            
            <div class="message message-error" id="errorMessage">
                请至少选择一个运算符！
            </div>
            
            <div class="message message-warning" id="warningMessage">
                警告信息
            </div>
        </main>
        
        <!-- 使用说明 - 默认显示在控制面板下方 -->
        <section class="instructions no-print" id="instructions">
            <h3>使用说明</h3>
            <ul>
                <li><strong>数值类型：</strong>选择整数、小数或分数作为题目中的数值类型</li>
                <li><strong>题目类型：</strong>选择计算题、填空题或比较大小题</li>
                <li><strong>数值范围：</strong>根据选择的数值类型设置相应的数值范围(1-999)</li>
                <li><strong>基本运算：</strong>选择需要的运算符（加法、减法、乘法、除法）</li>
                <li><strong>高级运算：</strong>选择连加连减、混合运算等高级运算类型</li>
                <li><strong>数字个数：</strong>设置高级运算中使用的数字个数（3-5个）</li>
                <li><strong>计时功能：</strong>右上角计时器可设置考试时间，支持开始、暂停和重置</li>
                <li><strong>生成题目：</strong>点击"立即生成"按钮生成题目</li>
                <li><strong>打印功能：</strong>可以打印试卷（不带答案）或打印答案</li>
                <li><strong>显示答案：</strong>可以在屏幕上显示或隐藏答案</li>
            </ul>
        </section>
        
        <section class="result-area" id="resultArea">
            <div class="result-header">
                <h2 class="result-title" id="resultTitle">1到100的加减乘除计算题</h2>
                <div class="result-actions no-print">
                    <button class="btn btn-primary" id="toggleAnswersBtn" aria-label="切换答案显示">显示答案</button>
                </div>
            </div>
            
            <div class="stats" id="statsInfo"></div>
            
            <!-- 打印专用标题 -->
            <div class="print-title" id="printTitle" style="display: none;"></div>
            
            <div class="problems-container" id="problemsContainer">
                <!-- 计算题将在这里生成 -->
            </div>
        </section>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const problemCountInput = document.getElementById('problemCount');
            const numberCountSelect = document.getElementById('numberCount');
            const operationBtns = document.querySelectorAll('.operation-btn');
            const typeBtns = document.querySelectorAll('.number-type-options .option-btn');
            const problemTypeBtns = document.querySelectorAll('.problem-type-options .option-btn');
            const digitBtns = document.querySelectorAll('.digit-btn');
            const generateBtn = document.getElementById('generateBtn');
            const printQuestionsBtn = document.getElementById('printQuestionsBtn');
            const printAnswersBtn = document.getElementById('printAnswersBtn');
            const toggleAnswersBtn = document.getElementById('toggleAnswersBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const resultArea = document.getElementById('resultArea');
            const problemsContainer = document.getElementById('problemsContainer');
            const resultTitle = document.getElementById('resultTitle');
            const printTitle = document.getElementById('printTitle');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const warningMessage = document.getElementById('warningMessage');
            const statsInfo = document.getElementById('statsInfo');
            const instructions = document.getElementById('instructions');
            
            // 计时器相关元素
            const timerDisplay = document.getElementById('timerDisplay');
            const startTimerBtn = document.getElementById('startTimer');
            const pauseTimerBtn = document.getElementById('pauseTimer');
            const resetTimerBtn = document.getElementById('resetTimer');
            const timerHoursInput = document.getElementById('timerHours');
            const timerMinutesInput = document.getElementById('timerMinutes');
            const timerSecondsInput = document.getElementById('timerSeconds');
            
            // 范围输入框
            const integerRange = document.getElementById('integerRange');
            const decimalRange = document.getElementById('decimalRange');
            const fractionRange = document.getElementById('fractionRange');
            
            // 整数范围
            const intMinInput = document.getElementById('intMin');
            const intMaxInput = document.getElementById('intMax');
            
            // 小数范围
            const decMinInput = document.getElementById('decMin');
            const decMaxInput = document.getElementById('decMax');
            
            // 分数范围
            const fracNumMinInput = document.getElementById('fracNumMin');
            const fracNumMaxInput = document.getElementById('fracNumMax');
            const fracDenMinInput = document.getElementById('fracDenMin');
            const fracDenMaxInput = document.getElementById('fracDenMax');
            
            // 计时器变量
            let timerInterval;
            let totalSeconds = 15 * 60; // 默认15分钟
            let remainingSeconds = totalSeconds;
            let timerRunning = false;
            let lastThreeMinutesAnnounced = false;
            let examStarted = false;
            
            // 语音合成
            const synth = window.speechSynthesis;
            
            // 初始化计时器功能
            function initTimer() {
                startTimerBtn.addEventListener('click', startTimer);
                pauseTimerBtn.addEventListener('click', pauseTimer);
                resetTimerBtn.addEventListener('click', resetTimer);
                
                // 监听时间输入变化
                [timerHoursInput, timerMinutesInput, timerSecondsInput].forEach(input => {
                    input.addEventListener('change', updateTotalTime);
                });
                
                updateTimerDisplay();
            }
            
            // 更新总时间
            function updateTotalTime() {
                const hours = parseInt(timerHoursInput.value) || 0;
                const minutes = parseInt(timerMinutesInput.value) || 0;
                const seconds = parseInt(timerSecondsInput.value) || 0;
                
                totalSeconds = hours * 3600 + minutes * 60 + seconds;
                remainingSeconds = totalSeconds;
                updateTimerDisplay();
            }
            
            // 开始计时
            function startTimer() {
                if (!timerRunning && remainingSeconds > 0) {
                    timerRunning = true;
                    startTimerBtn.disabled = true;
                    pauseTimerBtn.disabled = false;
                    
                    // 如果是第一次开始，播放考试开始提示
                    if (!examStarted) {
                        examStarted = true;
                        speak("考试开始，请考生答题");
                    } else {
                        speak("考试继续");
                    }
                    
                    timerInterval = setInterval(() => {
                        remainingSeconds--;
                        updateTimerDisplay();
                        
                        // 检查最后三分钟
                        if (remainingSeconds <= 180 && remainingSeconds > 0 && !lastThreeMinutesAnnounced) {
                            lastThreeMinutesAnnounced = true;
                            speak("还有最后三分钟，请尽快答题");
                            timerDisplay.classList.add('warning');
                        }
                        
                        // 检查时间到
                        if (remainingSeconds <= 0) {
                            clearInterval(timerInterval);
                            timerRunning = false;
                            startTimerBtn.disabled = false;
                            pauseTimerBtn.disabled = true;
                            speak("考试时间到，请交卷");
                            timerDisplay.classList.remove('warning');
                            timerDisplay.classList.add('danger');
                        }
                    }, 1000);
                }
            }
            
            // 暂停计时
            function pauseTimer() {
                if (timerRunning) {
                    timerRunning = false;
                    clearInterval(timerInterval);
                    startTimerBtn.disabled = false;
                    pauseTimerBtn.disabled = true;
                    speak("考试暂停");
                }
            }
            
            // 重置计时器
            function resetTimer() {
                timerRunning = false;
                clearInterval(timerInterval);
                startTimerBtn.disabled = false;
                pauseTimerBtn.disabled = true;
                examStarted = false;
                lastThreeMinutesAnnounced = false;
                
                updateTotalTime();
                timerDisplay.classList.remove('warning', 'danger');
            }
            
            // 更新计时器显示
            function updateTimerDisplay() {
                const hours = Math.floor(remainingSeconds / 3600);
                const minutes = Math.floor((remainingSeconds % 3600) / 60);
                const seconds = remainingSeconds % 60;
                
                if (hours > 0) {
                    timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }
            
            // 语音播报
            function speak(text) {
                if (synth && text) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.0;
                    synth.speak(utterance);
                }
            }
            
            // 选中的运算符
            let selectedOperations = ['+', '-'];
            // 选中的数值类型
            let selectedType = 'integer';
            // 选中的题目类型
            let selectedProblemType = 'calculation';
            // 小数位数
            let decimalDigits = 1;
            // 题目集合，用于去重
            let problemSet = new Set();
            // 最大尝试次数，避免无限循环
            const MAX_ATTEMPTS = 10000;
            
            // 添加输入限制
            function addInputLimits() {
                // 题目数量限制
                problemCountInput.addEventListener('change', function() {
                    if (this.value > 200) {
                        this.value = 200;
                    } else if (this.value < 1) {
                        this.value = 1;
                    }
                });
                
                // 整数范围限制
                [intMinInput, intMaxInput].forEach(input => {
                    input.addEventListener('change', function() {
                        if (this.value > 999) {
                            this.value = 999;
                        } else if (this.value < 1) {
                            this.value = 1;
                        }
                    });
                });
                
                // 小数范围限制
                [decMinInput, decMaxInput].forEach(input => {
                    input.addEventListener('change', function() {
                        if (this.value > 999) {
                            this.value = 999;
                        } else if (this.value < 1) {
                            this.value = 1;
                        }
                    });
                });
                
                // 分数范围限制
                [fracNumMinInput, fracNumMaxInput, fracDenMinInput, fracDenMaxInput].forEach(input => {
                    input.addEventListener('change', function() {
                        if (this.value > 999) {
                            this.value = 999;
                        } else if (this.value < 1) {
                            this.value = 1;
                        }
                    });
                });
            }
            
            // 初始化运算符选择
            operationBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    this.classList.add('flash');
                    
                    setTimeout(() => {
                        this.classList.remove('flash');
                    }, 500);
                    
                    updateSelectedOperations();
                });
            });
            
            // 初始化数值类型选择
            typeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    typeBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    this.classList.add('flash');
                    
                    setTimeout(() => {
                        this.classList.remove('flash');
                    }, 500);
                    
                    selectedType = this.dataset.type;
                    updateRangeVisibility();
                });
            });
            
            // 初始化题目类型选择
            problemTypeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    problemTypeBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    this.classList.add('flash');
                    
                    setTimeout(() => {
                        this.classList.remove('flash');
                    }, 500);
                    
                    selectedProblemType = this.dataset.problemType;
                });
            });
            
            // 初始化小数位数选择
            digitBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    digitBtns.forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    decimalDigits = parseInt(this.dataset.digits);
                });
            });
            
            // 更新范围输入框的显示
            function updateRangeVisibility() {
                integerRange.classList.add('hidden');
                decimalRange.classList.add('hidden');
                fractionRange.classList.add('hidden');
                
                if (selectedType === 'integer') {
                    integerRange.classList.remove('hidden');
                } else if (selectedType === 'decimal') {
                    decimalRange.classList.remove('hidden');
                } else if (selectedType === 'fraction') {
                    fractionRange.classList.remove('hidden');
                }
            }
            
            // 更新选中的运算符
            function updateSelectedOperations() {
                selectedOperations = [];
                document.querySelectorAll('.operation-btn.selected').forEach(btn => {
                    selectedOperations.push(btn.dataset.operation);
                });
            }
            
            // 生成随机整数
            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            // 生成随机小数
            function getRandomDecimal(min, max) {
                const factor = Math.pow(10, decimalDigits);
                const intMin = Math.floor(min * factor);
                const intMax = Math.floor(max * factor);
                const randomInt = getRandomInt(intMin, intMax);
                const result = randomInt / factor;
                
                // 确保结果的小数位数正确
                return parseFloat(result.toFixed(decimalDigits));
            }
            
            // 生成唯一的问题标识
            function getProblemKey(problemText) {
                return problemText;
            }
            
            // 检查题目文本长度，决定是否需要换行
            function checkProblemLength(problemText) {
                // 简单估算文本长度，超过一定长度需要换行
                return problemText.length > 25;
            }
            
            // 生成计算题
            function generateProblems() {
                // 验证输入
                const problemCount = parseInt(problemCountInput.value);
                const numberCount = parseInt(numberCountSelect.value);
                
                // 获取范围值
                let min, max, fracNumMin, fracNumMax, fracDenMin, fracDenMax;
                
                if (selectedType === 'integer') {
                    min = parseInt(intMinInput.value);
                    max = parseInt(intMaxInput.value);
                } else if (selectedType === 'decimal') {
                    min = parseFloat(decMinInput.value);
                    max = parseFloat(decMaxInput.value);
                } else if (selectedType === 'fraction') {
                    fracNumMin = parseInt(fracNumMinInput.value);
                    fracNumMax = parseInt(fracNumMaxInput.value);
                    fracDenMin = parseInt(fracDenMinInput.value);
                    fracDenMax = parseInt(fracDenMaxInput.value);
                }
                
                // 验证范围
                if (selectedType === 'integer' && min >= max) {
                    showMessage('最小值必须小于最大值！', 'error');
                    return;
                }
                
                if (selectedType === 'decimal' && min >= max) {
                    showMessage('最小值必须小于最大值！', 'error');
                    return;
                }
                
                if (selectedType === 'fraction' && (fracNumMin >= fracNumMax || fracDenMin >= fracDenMax)) {
                    showMessage('分子和分母的最小值必须小于最大值！', 'error');
                    return;
                }
                
                if (selectedOperations.length === 0) {
                    showMessage('请至少选择一个运算符！', 'error');
                    return;
                }
                
                // 清空问题容器和集合
                problemsContainer.innerHTML = '';
                problemSet.clear();
                
                // 计算最大可能题目数
                let maxPossibleProblems = calculateMaxPossibleProblems();
                
                // 如果请求的题目数量超过最大可能数量，则显示警告
                if (problemCount > maxPossibleProblems) {
                    showMessage(`无法生成 ${problemCount} 个不同的题目，已生成最大数量 ${maxPossibleProblems} 个题目`, 'warning');
                }
                
                // 实际要生成的题目数量
                const actualProblemCount = Math.min(problemCount, maxPossibleProblems);
                
                // 设置打印标题
                const operationNames = getOperationNames();
                const problemTypeNames = {
                    'calculation': '计算题',
                    'fill-blank': '填空题',
                    'comparison': '比较大小题'
                };
                
                let rangeText = '';
                if (selectedType === 'integer') {
                    rangeText = `${min}到${max}之间的`;
                } else if (selectedType === 'decimal') {
                    rangeText = `${min}到${max}之间的${decimalDigits}位小数`;
                } else if (selectedType === 'fraction') {
                    rangeText = `分子${fracNumMin}-${fracNumMax}分母${fracDenMin}-${fracDenMax}之间的`;
                }
                
                printTitle.textContent = `${rangeText}${operationNames}${problemTypeNames[selectedProblemType]}`;
                resultTitle.textContent = `${rangeText}${operationNames}${problemTypeNames[selectedProblemType]}`;
                
                // 将使用说明移动到结果区域内
                if (resultArea.style.display === 'block') {
                    resultArea.appendChild(instructions);
                }
                
                // 按题型分组生成题目
                const problemsByType = {};
                let generatedCount = 0;
                
                // 初始化每种题型的题目数组
                selectedOperations.forEach(op => {
                    problemsByType[op] = [];
                });
                
                // 生成题目 - 优化版本
                let attempts = 0;
                
                // 按运算类型分组尝试生成
                for (const operation of selectedOperations) {
                    let operationAttempts = 0;
                    const maxOperationAttempts = Math.min(MAX_ATTEMPTS / selectedOperations.length, 1000);
                    
                    while (problemsByType[operation].length < Math.ceil(actualProblemCount / selectedOperations.length) && 
                           operationAttempts < maxOperationAttempts) {
                        
                        let problemText, answer;
                        
                        try {
                            // 根据题目类型生成合适的题目
                            switch (selectedProblemType) {
                                case 'calculation':
                                    ({problemText, answer} = generateCalculationProblem(operation, numberCount));
                                    break;
                                case 'fill-blank':
                                    ({problemText, answer} = generateFillBlankProblem(operation, numberCount));
                                    break;
                                case 'comparison':
                                    ({problemText, answer} = generateComparisonProblem(operation, numberCount));
                                    break;
                            }
                            
                            // 检查题目是否重复且有效
                            const problemKey = getProblemKey(problemText);
                            if (!problemSet.has(problemKey)) {
                                problemSet.add(problemKey);
                                problemsByType[operation].push({problemText, answer});
                                generatedCount++;
                            }
                        } catch (error) {
                            console.warn('生成题目失败:', error);
                        }
                        
                        operationAttempts++;
                        attempts++;
                        
                        // 如果总尝试次数过多，提前退出
                        if (attempts >= MAX_ATTEMPTS) break;
                    }
                    
                    if (attempts >= MAX_ATTEMPTS) break;
                }
                
                // 按题型显示题目
                const basicOperations = ['+', '-', '×', '÷'];
                const advancedOperations = ['continuous', 'mixed', 'continuous-mul-div', 'mixed-mul-div', 'all-mixed'];
                
                for (const operation in problemsByType) {
                    if (problemsByType[operation].length > 0) {
                        const sectionElement = document.createElement('div');
                        
                        // 根据运算类型设置不同的CSS类
                        if (basicOperations.includes(operation)) {
                            sectionElement.className = 'problem-section basic-operation-section';
                        } else if (advancedOperations.includes(operation)) {
                            sectionElement.className = 'problem-section advanced-operation-section';
                        } else {
                            sectionElement.className = 'problem-section';
                        }
                        
                        const sectionProblems = document.createElement('div');
                        sectionProblems.className = 'section-problems';
                        
                        problemsByType[operation].forEach(problem => {
                            const problemElement = document.createElement('div');
                            problemElement.className = 'problem';
                            
                            // 检查题目长度，决定是否需要换行
                            if (checkProblemLength(problem.problemText)) {
                                problemElement.classList.add('multiline');
                            }
                            
                            // 格式化分数显示
                            let formattedProblemText = formatFractionsInText(problem.problemText);
                            let formattedAnswer = formatFraction(problem.answer);
                            
                            // 根据题目类型设置不同的空白区域
                            let blankHtml;
                            if (selectedProblemType === 'calculation') {
                                // 计算题：等号后空白
                                blankHtml = '<span class="blank"></span>';
                                formattedProblemText = `${formattedProblemText} = ${blankHtml}`;
                            } else if (selectedProblemType === 'fill-blank') {
                                // 填空题：已经包含括号，不需要额外添加
                                // 将括号替换为有间距的空白区域
                                formattedProblemText = formattedProblemText.replace(/\(   \)/g, '<span class="fill-blank"></span>');
                            } else if (selectedProblemType === 'comparison') {
                                // 比较大小题：问号处空白
                                blankHtml = '<span class="blank"></span>';
                                formattedProblemText = formattedProblemText.replace('?', blankHtml);
                            }
                            
                            problemElement.innerHTML = `
                                <div>
                                    <div class="problem-text">${formattedProblemText}<span class="answer">${formattedAnswer}</span></div>
                                </div>
                            `;
                            
                            sectionProblems.appendChild(problemElement);
                        });
                        
                        sectionElement.appendChild(sectionProblems);
                        problemsContainer.appendChild(sectionElement);
                    }
                }
                
                // 更新统计信息
                statsInfo.textContent = `共生成 ${generatedCount} 道题目`;
                
                // 显示结果区域
                resultArea.style.display = 'block';
                
                // 将使用说明移动到结果区域内
                resultArea.appendChild(instructions);
                
                // 显示成功消息
                showMessage(`成功生成 ${generatedCount} 道题目！`, 'success');
            }
            
            // 生成计算题
            function generateCalculationProblem(operation, numberCount) {
                try {
                    // 根据运算符类型生成不同的题目
                    if (['+', '-', '×', '÷'].includes(operation)) {
                        return generateBasicProblem(operation);
                    } else {
                        // 高级运算 - 添加尝试次数限制
                        let attempts = 0;
                        const maxAttempts = 100;
                        
                        while (attempts < maxAttempts) {
                            try {
                                switch (operation) {
                                    case 'continuous':
                                        return generateContinuousProblem(numberCount);
                                    case 'mixed':
                                        return generateMixedProblem(numberCount);
                                    case 'continuous-mul-div':
                                        return generateContinuousMulDivProblem(numberCount);
                                    case 'mixed-mul-div':
                                        return generateMixedMulDivProblem(numberCount);
                                    case 'all-mixed':
                                        return generateAllMixedProblem(numberCount);
                                }
                            } catch (error) {
                                attempts++;
                                if (attempts >= maxAttempts) {
                                    throw new Error(`生成${operation}题目失败，尝试次数过多`);
                                }
                            }
                        }
                    }
                } catch (error) {
                    // 如果高级运算生成失败，回退到基本运算
                    console.warn(`高级运算${operation}生成失败，使用基本运算替代:`, error);
                    const basicOperations = ['+', '-', '×', '÷'];
                    const fallbackOp = basicOperations[Math.floor(Math.random() * basicOperations.length)];
                    return generateBasicProblem(fallbackOp);
                }
            }
            
            // 生成填空题
            function generateFillBlankProblem(operation, numberCount) {
                // 根据运算符类型生成不同的填空题
                if (['+', '-', '×', '÷'].includes(operation)) {
                    return generateBasicFillInBlank(operation);
                } else {
                    // 高级运算填空题
                    switch (operation) {
                        case 'continuous':
                            return generateContinuousFillInBlank(numberCount);
                        case 'mixed':
                            return generateMixedFillInBlank(numberCount);
                        case 'continuous-mul-div':
                            return generateContinuousMulDivFillInBlank(numberCount);
                        case 'mixed-mul-div':
                            return generateMixedMulDivFillInBlank(numberCount);
                        case 'all-mixed':
                            return generateAllMixedFillInBlank(numberCount);
                    }
                }
            }
            
            // 生成比较大小题
            function generateComparisonProblem(operation, numberCount) {
                // 生成两个表达式或数字
                const typeIdx = getRandomInt(1, 3);
                let leftExpr, rightExpr, leftValue, rightValue, answer;
                
                // 根据选择的运算类型生成表达式
                if (['+', '-', '×', '÷'].includes(operation)) {
                    // 基本运算比较
                    switch (typeIdx) {
                        case 1: // 表达式比较表达式
                            ({problemText: leftExpr, answer: leftValue} = generateBasicProblem(operation));
                            ({problemText: rightExpr, answer: rightValue} = generateBasicProblem(operation));
                            break;
                        case 2: // 表达式比较数字
                            ({problemText: leftExpr, answer: leftValue} = generateBasicProblem(operation));
                            rightValue = generateNumber();
                            rightExpr = rightValue;
                            break;
                        case 3: // 数字比较表达式
                            leftValue = generateNumber();
                            leftExpr = leftValue;
                            ({problemText: rightExpr, answer: rightValue} = generateBasicProblem(operation));
                            break;
                    }
                } else {
                    // 高级运算比较
                    switch (typeIdx) {
                        case 1: // 表达式比较表达式
                            ({problemText: leftExpr, answer: leftValue} = generateCalculationProblem(operation, numberCount));
                            ({problemText: rightExpr, answer: rightValue} = generateCalculationProblem(operation, numberCount));
                            break;
                        case 2: // 表达式比较数字
                            ({problemText: leftExpr, answer: leftValue} = generateCalculationProblem(operation, numberCount));
                            rightValue = generateNumber();
                            rightExpr = rightValue;
                            break;
                        case 3: // 数字比较表达式
                            leftValue = generateNumber();
                            leftExpr = leftValue;
                            ({problemText: rightExpr, answer: rightValue} = generateCalculationProblem(operation, numberCount));
                            break;
                    }
                }
                
                // 确定比较符号
                let compareSymbol;
                if (compareValues(leftValue, rightValue) > 0) {
                    compareSymbol = '＞';
                    answer = '＞';
                } else if (compareValues(leftValue, rightValue) < 0) {
                    compareSymbol = '＜';
                    answer = '＜';
                } else {
                    compareSymbol = '＝';
                    answer = '＝';
                }
                
                return {
                    problemText: `${leftExpr} ? ${rightExpr}`,
                    answer: answer
                };
            }
            
            // 生成数字（根据当前选择的数值类型）
            function generateNumber() {
                try {
                    if (selectedType === 'integer') {
                        const min = parseInt(intMinInput.value);
                        const max = parseInt(intMaxInput.value);
                        if (min >= max) throw new Error('整数范围无效');
                        return getRandomInt(min, max);
                    } else if (selectedType === 'decimal') {
                        const min = parseFloat(decMinInput.value);
                        const max = parseFloat(decMaxInput.value);
                        if (min >= max) throw new Error('小数范围无效');
                        return getRandomDecimal(min, max);
                    } else if (selectedType === 'fraction') {
                        const numMin = parseInt(fracNumMinInput.value);
                        const numMax = parseInt(fracNumMaxInput.value);
                        const denMin = parseInt(fracDenMinInput.value);
                        const denMax = parseInt(fracDenMaxInput.value);
                        
                        if (numMin >= numMax || denMin >= denMax) {
                            throw new Error('分数范围无效');
                        }
                        
                        const numerator = getRandomInt(numMin, numMax);
                        let denominator = getRandomInt(denMin, denMax);
                        
                        // 确保分母不为0，且分子小于分母（真分数）
                        let attempts = 0;
                        while ((denominator === 0 || numerator >= denominator) && attempts < 10) {
                            denominator = getRandomInt(denMin, denMax);
                            attempts++;
                        }
                        
                        if (denominator === 0) denominator = 1; // 安全回退
                        if (numerator >= denominator) {
                            // 如果还是假分数，调整分子
                            return `${Math.min(numerator, denominator-1)}/${denominator}`;
                        }
                        
                        return `${numerator}/${denominator}`;
                    }
                } catch (error) {
                    console.error('生成数字失败:', error);
                    // 返回安全默认值
                    return selectedType === 'integer' ? 1 : 
                           selectedType === 'decimal' ? 1.0 : '1/2';
                }
            }
            
            // 格式化文本中的分数
            function formatFractionsInText(text) {
                // 匹配分数格式 "数字/数字"
                return text.replace(/(\d+)\/(\d+)/g, function(match, numerator, denominator) {
                    return `<span class="fraction"><span class="numerator">${numerator}</span><span class="denominator">${denominator}</span></span>`;
                });
            }
            
            // 格式化单个分数
            function formatFraction(value) {
                if (typeof value === 'string' && value.includes('/')) {
                    const parts = value.split('/');
                    return `<span class="fraction"><span class="numerator">${parts[0]}</span><span class="denominator">${parts[1]}</span></span>`;
                }
                return value;
            }
            
            // 生成基本运算填空题
            function generateBasicFillInBlank(operation) {
                let num1, num2, result, missingPart;
                
                // 根据数值类型生成数字
                num1 = generateNumber();
                num2 = generateNumber();
                
                // 根据运算符计算结果
                switch (operation) {
                    case '+':
                        result = calculate(num1, num2, '+');
                        break;
                    case '-':
                        // 确保结果不为负
                        if (compareValues(num1, num2) < 0) {
                            [num1, num2] = [num2, num1];
                        }
                        result = calculate(num1, num2, '-');
                        break;
                    case '×':
                        result = calculate(num1, num2, '×');
                        break;
                    case '÷':
                        // 确保除法合理
                        if (selectedType === 'integer') {
                            // 整数除法确保结果为整数
                            do {
                                num2 = generateNumber();
                                result = generateNumber();
                                num1 = calculate(result, num2, '×');
                            } while (compareValues(num1, getMinValue()) < 0 || compareValues(num1, getMaxValue()) > 0);
                        } else {
                            result = calculate(num1, num2, '÷');
                        }
                        break;
                }
                
                // 随机决定隐藏哪个部分
                const hiddenPart = getRandomInt(1, 3); // 1: 隐藏第一个数, 2: 隐藏第二个数, 3: 隐藏结果
                
                let problemText, answer, fullExpression;
                
                switch (hiddenPart) {
                    case 1: // 隐藏第一个数
                        problemText = `(   ) ${operation} ${num2} = ${result}`;
                        answer = num1;
                        fullExpression = `${num1} ${operation} ${num2} = ${result}`;
                        missingPart = 'first';
                        break;
                    case 2: // 隐藏第二个数
                        problemText = `${num1} ${operation} (   ) = ${result}`;
                        answer = num2;
                        fullExpression = `${num1} ${operation} ${num2} = ${result}`;
                        missingPart = 'second';
                        break;
                    case 3: // 隐藏结果
                        problemText = `${num1} ${operation} ${num2} = (   )`;
                        answer = result;
                        fullExpression = `${num1} ${operation} ${num2} = ${result}`;
                        missingPart = 'result';
                        break;
                }
                
                return {
                    problemText: problemText,
                    answer: answer,
                    fullExpression: fullExpression,
                    missingPart: missingPart
                };
            }
            
            // 生成连加连减填空题
            function generateContinuousFillInBlank(numberCount) {
                const numbers = [];
                let result;
                
                // 生成数字
                for (let i = 0; i < numberCount; i++) {
                    numbers.push(generateNumber());
                }
                
                // 确定是连加还是连减
                const isAddition = Math.random() > 0.5;
                
                if (isAddition) {
                    // 连加
                    result = numbers.reduce((sum, num) => calculate(sum, num, '+'), getZeroValue());
                    
                    // 随机隐藏一个数字
                    const hiddenIndex = getRandomInt(0, numbers.length - 1);
                    const numbersWithBlank = [...numbers];
                    numbersWithBlank[hiddenIndex] = '(   )';
                    
                    return {
                        problemText: numbersWithBlank.join(' + ') + ' = ' + result,
                        answer: numbers[hiddenIndex],
                        fullExpression: numbers.join(' + ') + ' = ' + result,
                        missingPart: `number${hiddenIndex + 1}`
                    };
                } else {
                    // 连减
                    let firstNum = generateNumber();
                    // 确保第一个数足够大
                    while (compareValues(firstNum, numbers.slice(1).reduce((sum, num) => calculate(sum, num, '+'), getZeroValue())) < 0) {
                        firstNum = generateNumber();
                    }
                    
                    const allNumbers = [firstNum, ...numbers.slice(1)];
                    result = allNumbers.slice(1).reduce((diff, num) => calculate(diff, num, '-'), firstNum);
                    
                    // 随机隐藏一个数字
                    const hiddenIndex = getRandomInt(0, allNumbers.length - 1);
                    const numbersWithBlank = [...allNumbers];
                    numbersWithBlank[hiddenIndex] = '(   )';
                    
                    return {
                        problemText: numbersWithBlank.join(' - ') + ' = ' + result,
                        answer: allNumbers[hiddenIndex],
                        fullExpression: allNumbers.join(' - ') + ' = ' + result,
                        missingPart: `number${hiddenIndex + 1}`
                    };
                }
            }
            
            // 生成加减混合填空题
            function generateMixedFillInBlank(numberCount) {
                const numbers = [];
                const operations = [];
                let result;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                result = numbers[0];
                
                // 生成后续数字和运算符
                for (let i = 1; i < numberCount; i++) {
                    const isAddition = Math.random() > 0.5;
                    let num = generateNumber();
                    
                    numbers.push(num);
                    operations.push(isAddition ? '+' : '-');
                    
                    if (isAddition) {
                        result = calculate(result, num, '+');
                    } else {
                        // 确保减法后结果不为负数
                        if (compareValues(result, num) < 0) {
                            // 如果结果为负数，改为加法
                            operations[i-1] = '+';
                            result = calculate(result, num, '+');
                        } else {
                            result = calculate(result, num, '-');
                        }
                    }
                }
                
                // 随机隐藏一个数字
                const hiddenIndex = getRandomInt(0, numbers.length - 1);
                const numbersWithBlank = [...numbers];
                numbersWithBlank[hiddenIndex] = '(   )';
                
                // 构建表达式
                let expression = numbersWithBlank[0].toString();
                for (let i = 1; i < numbersWithBlank.length; i++) {
                    expression += ` ${operations[i-1]} ${numbersWithBlank[i]}`;
                }
                expression += ` = ${result}`;
                
                return {
                    problemText: expression,
                    answer: numbers[hiddenIndex],
                    fullExpression: numbers.join(' ') + ' = ' + result,
                    missingPart: `number${hiddenIndex + 1}`
                };
            }
            
            // 生成连乘连除填空题
            function generateContinuousMulDivFillInBlank(numberCount) {
                const numbers = [];
                let result;
                
                // 生成数字
                for (let i = 0; i < numberCount; i++) {
                    numbers.push(generateNumber());
                }
                
                // 确定是连乘还是连除
                const isMultiplication = Math.random() > 0.5;
                
                if (isMultiplication) {
                    // 连乘
                    result = numbers.reduce((product, num) => calculate(product, num, '×'), getOneValue());
                    
                    // 随机隐藏一个数字
                    const hiddenIndex = getRandomInt(0, numbers.length - 1);
                    const numbersWithBlank = [...numbers];
                    numbersWithBlank[hiddenIndex] = '(   )';
                    
                    return {
                        problemText: numbersWithBlank.join(' × ') + ' = ' + result,
                        answer: numbers[hiddenIndex],
                        fullExpression: numbers.join(' × ') + ' = ' + result,
                        missingPart: `number${hiddenIndex + 1}`
                    };
                } else {
                    // 连除
                    let firstNum = generateNumber();
                    const otherNums = [];
                    for (let i = 1; i < numberCount; i++) {
                        otherNums.push(generateNumber());
                    }
                    
                    result = otherNums.reduce((quotient, num) => calculate(quotient, num, '÷'), firstNum);
                    
                    const allNumbers = [firstNum, ...otherNums];
                    const hiddenIndex = getRandomInt(0, allNumbers.length - 1);
                    const numbersWithBlank = [...allNumbers];
                    numbersWithBlank[hiddenIndex] = '(   )';
                    
                    return {
                        problemText: numbersWithBlank.join(' ÷ ') + ' = ' + result,
                        answer: allNumbers[hiddenIndex],
                        fullExpression: allNumbers.join(' ÷ ') + ' = ' + result,
                        missingPart: `number${hiddenIndex + 1}`
                    };
                }
            }
            
            // 生成乘除混合填空题
            function generateMixedMulDivFillInBlank(numberCount) {
                const numbers = [];
                const operations = [];
                let result;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                result = numbers[0];
                
                // 生成后续数字和运算符
                for (let i = 1; i < numberCount; i++) {
                    const isMultiplication = Math.random() > 0.5;
                    let num = generateNumber();
                    
                    numbers.push(num);
                    operations.push(isMultiplication ? '×' : '÷');
                    
                    if (isMultiplication) {
                        result = calculate(result, num, '×');
                    } else {
                        result = calculate(result, num, '÷');
                    }
                }
                
                // 随机隐藏一个数字
                const hiddenIndex = getRandomInt(0, numbers.length - 1);
                const numbersWithBlank = [...numbers];
                numbersWithBlank[hiddenIndex] = '(   )';
                
                // 构建表达式
                let expression = numbersWithBlank[0].toString();
                for (let i = 1; i < numbersWithBlank.length; i++) {
                    expression += ` ${operations[i-1]} ${numbersWithBlank[i]}`;
                }
                expression += ` = ${result}`;
                
                return {
                    problemText: expression,
                    answer: numbers[hiddenIndex],
                    fullExpression: numbers.join(' ') + ' = ' + result,
                    missingPart: `number${hiddenIndex + 1}`
                };
            }
            
            // 生成加减乘除混合填空题
            function generateAllMixedFillInBlank(numberCount) {
                const numbers = [];
                const operations = [];
                let result;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                result = numbers[0];
                
                // 生成后续数字和运算符
                for (let i = 1; i < numberCount; i++) {
                    const operation = ['+', '-', '×', '÷'][getRandomInt(0, 3)];
                    operations.push(operation);
                    
                    let num = generateNumber();
                    numbers.push(num);
                    
                    // 根据运算符计算结果
                    result = calculate(result, num, operation);
                }
                
                // 随机隐藏一个数字
                const hiddenIndex = getRandomInt(0, numbers.length - 1);
                const numbersWithBlank = [...numbers];
                numbersWithBlank[hiddenIndex] = '(   )';
                
                // 构建表达式
                let expression = numbersWithBlank[0].toString();
                for (let i = 1; i < numbersWithBlank.length; i++) {
                    expression += ` ${operations[i-1]} ${numbersWithBlank[i]}`;
                }
                expression += ` = ${result}`;
                
                return {
                    problemText: expression,
                    answer: numbers[hiddenIndex],
                    fullExpression: numbers.join(' ') + ' = ' + result,
                    missingPart: `number${hiddenIndex + 1}`
                };
            }
            
            // 生成基本运算题目
            function generateBasicProblem(operation) {
                let num1, num2, answer;
                
                // 根据数值类型生成数字
                num1 = generateNumber();
                num2 = generateNumber();
                
                // 根据运算符计算结果
                switch (operation) {
                    case '+':
                        answer = calculate(num1, num2, '+');
                        break;
                    case '-':
                        // 确保结果不为负
                        if (compareValues(num1, num2) < 0) {
                            [num1, num2] = [num2, num1];
                        }
                        answer = calculate(num1, num2, '-');
                        break;
                    case '×':
                        answer = calculate(num1, num2, '×');
                        break;
                    case '÷':
                        // 确保除法合理
                        if (selectedType === 'integer') {
                            // 整数除法确保结果为整数
                            do {
                                num2 = generateNumber();
                                result = generateNumber();
                                num1 = calculate(result, num2, '×');
                            } while (compareValues(num1, getMinValue()) < 0 || compareValues(num1, getMaxValue()) > 0);
                        } else {
                            answer = calculate(num1, num2, '÷');
                        }
                        break;
                }
                
                return {
                    problemText: `${num1} ${operation} ${num2}`,
                    answer: answer
                };
            }
            
            // 优化连加连减生成，避免无限循环
            function generateContinuousProblem(numberCount) {
                const numbers = [];
                let answer;
                
                // 限制数字个数范围
                const actualNumberCount = Math.min(Math.max(3, numberCount), 5);
                
                // 生成数字 - 限制尝试次数
                let attempts = 0;
                while (numbers.length < actualNumberCount && attempts < 50) {
                    const num = generateNumber();
                    if (num !== undefined && num !== null) {
                        numbers.push(num);
                    }
                    attempts++;
                }
                
                if (numbers.length < 3) {
                    // 如果无法生成足够数字，使用默认值
                    numbers.push(generateNumber(), generateNumber(), generateNumber());
                }
                
                const isAddition = Math.random() > 0.5;
                
                if (isAddition) {
                    // 连加
                    answer = numbers.reduce((sum, num) => {
                        const result = calculate(sum, num, '+');
                        return result !== undefined ? result : sum;
                    }, getZeroValue());
                    
                    return {
                        problemText: numbers.join(' + '),
                        answer: answer
                    };
                } else {
                    // 连减 - 确保第一个数足够大
                    let firstNum = generateNumber();
                    let otherNums = numbers.slice(1);
                    
                    // 计算其他数字的总和
                    const otherSum = otherNums.reduce((sum, num) => {
                        const result = calculate(sum, num, '+');
                        return result !== undefined ? result : sum;
                    }, getZeroValue());
                    
                    // 确保第一个数大于等于其他数字之和
                    let safetyAttempts = 0;
                    while (compareValues(firstNum, otherSum) < 0 && safetyAttempts < 20) {
                        firstNum = generateNumber();
                        safetyAttempts++;
                    }
                    
                    const allNumbers = [firstNum, ...otherNums];
                    answer = allNumbers.slice(1).reduce((diff, num) => {
                        const result = calculate(diff, num, '-');
                        return result !== undefined ? result : diff;
                    }, firstNum);
                    
                    return {
                        problemText: allNumbers.join(' - '),
                        answer: answer
                    };
                }
            }
            
            // 生成加减混合题目
            function generateMixedProblem(numberCount) {
                const numbers = [];
                let answer;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                answer = numbers[0];
                
                // 生成后续数字和运算符
                let problemText = numbers[0].toString();
                
                for (let i = 1; i < numberCount; i++) {
                    const isAddition = Math.random() > 0.5;
                    let num = generateNumber();
                    
                    if (isAddition) {
                        problemText += ` + ${num}`;
                        answer = calculate(answer, num, '+');
                    } else {
                        // 确保减法后结果不为负数
                        if (compareValues(answer, num) < 0) {
                            // 如果结果为负数，改为加法
                            problemText += ` + ${num}`;
                            answer = calculate(answer, num, '+');
                        } else {
                            problemText += ` - ${num}`;
                            answer = calculate(answer, num, '-');
                        }
                    }
                }
                
                return {
                    problemText: problemText,
                    answer: answer
                };
            }
            
            // 生成连乘连除题目
            function generateContinuousMulDivProblem(numberCount) {
                const numbers = [];
                let answer;
                
                // 生成数字
                for (let i = 0; i < numberCount; i++) {
                    numbers.push(generateNumber());
                }
                
                // 确定是连乘还是连除
                const isMultiplication = Math.random() > 0.5;
                
                if (isMultiplication) {
                    // 连乘
                    answer = numbers.reduce((product, num) => calculate(product, num, '×'), getOneValue());
                    return {
                        problemText: numbers.join(' × '),
                        answer: answer
                    };
                } else {
                    // 连除
                    let firstNum = generateNumber();
                    const otherNums = [];
                    for (let i = 1; i < numberCount; i++) {
                        otherNums.push(generateNumber());
                    }
                    
                    answer = otherNums.reduce((quotient, num) => calculate(quotient, num, '÷'), firstNum);
                    
                    return {
                        problemText: [firstNum, ...otherNums].join(' ÷ '),
                        answer: answer
                    };
                }
            }
            
            // 生成乘除混合题目
            function generateMixedMulDivProblem(numberCount) {
                const numbers = [];
                let answer;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                answer = numbers[0];
                
                // 生成后续数字和运算符
                let problemText = numbers[0].toString();
                
                for (let i = 1; i < numberCount; i++) {
                    const isMultiplication = Math.random() > 0.5;
                    let num = generateNumber();
                    
                    if (isMultiplication) {
                        problemText += ` × ${num}`;
                        answer = calculate(answer, num, '×');
                    } else {
                        problemText += ` ÷ ${num}`;
                        answer = calculate(answer, num, '÷');
                    }
                }
                
                return {
                    problemText: problemText,
                    answer: answer
                };
            }
            
            // 生成加减乘除混合题目
            function generateAllMixedProblem(numberCount) {
                const numbers = [];
                let answer;
                
                // 生成第一个数字
                numbers.push(generateNumber());
                answer = numbers[0];
                
                // 生成后续数字和运算符
                let problemText = numbers[0].toString();
                
                for (let i = 1; i < numberCount; i++) {
                    const operation = ['+', '-', '×', '÷'][getRandomInt(0, 3)];
                    let num = generateNumber();
                    
                    problemText += ` ${operation} ${num}`;
                    
                    // 根据运算符计算结果
                    answer = calculate(answer, num, operation);
                }
                
                return {
                    problemText: problemText,
                    answer: answer
                };
            }
            
            // 优化calculate函数，添加错误处理和负数检查
            function calculate(a, b, operation) {
                // 检查参数有效性
                if (a === undefined || a === null || b === undefined || b === null) {
                    throw new Error('计算参数无效');
                }
                
                try {
                    // 如果a或b是分数，转换为分数对象
                    if (typeof a === 'string' && a.includes('/')) {
                        a = parseFraction(a);
                    }
                    if (typeof b === 'string' && b.includes('/')) {
                        b = parseFraction(b);
                    }
                    
                    let result;
                    
                    // 根据运算符计算结果
                    switch (operation) {
                        case '+':
                            if (typeof a === 'object' || typeof b === 'object') {
                                result = addFractions(a, b);
                            } else {
                                if (selectedType === 'integer') {
                                    result = a + b;
                                } else {
                                    result = a + b;
                                    if (isNaN(result)) throw new Error('加法结果无效');
                                    result = parseFloat(result.toFixed(decimalDigits));
                                }
                            }
                            break;
                        case '-':
                            // 确保减法结果不为负数
                            if (compareValues(a, b) < 0) {
                                throw new Error('减法结果不能为负数');
                            }
                            
                            if (typeof a === 'object' || typeof b === 'object') {
                                result = subtractFractions(a, b);
                            } else {
                                if (selectedType === 'integer') {
                                    result = a - b;
                                } else {
                                    result = a - b;
                                    if (isNaN(result)) throw new Error('减法结果无效');
                                    result = parseFloat(result.toFixed(decimalDigits));
                                }
                            }
                            break;
                        case '×':
                            if (typeof a === 'object' || typeof b === 'object') {
                                result = multiplyFractions(a, b);
                            } else {
                                if (selectedType === 'integer') {
                                    result = a * b;
                                } else {
                                    result = a * b;
                                    if (isNaN(result)) throw new Error('乘法结果无效');
                                    result = parseFloat(result.toFixed(decimalDigits));
                                }
                            }
                            break;
                        case '÷':
                            if (typeof a === 'object' || typeof b === 'object') {
                                result = divideFractions(a, b);
                            } else {
                                if (selectedType === 'integer') {
                                    // 确保整数除法结果为整数且不为负数
                                    if (b === 0) throw new Error('除数不能为零');
                                    if (a % b !== 0) throw new Error('整数除法结果不是整数');
                                    if (a < b) throw new Error('除法结果不能为负数或小数');
                                    result = a / b;
                                } else {
                                    if (b === 0) throw new Error('除数不能为零');
                                    result = a / b;
                                    if (isNaN(result)) throw new Error('除法结果无效');
                                    if (result < 0) throw new Error('除法结果不能为负数');
                                    result = parseFloat(result.toFixed(decimalDigits));
                                }
                            }
                            break;
                    }
                    
                    // 最终检查结果是否为负数
                    if (typeof result === 'number' && result < 0) {
                        throw new Error('计算结果不能为负数');
                    }
                    
                    return result;
                } catch (error) {
                    console.error('计算错误:', error, a, b, operation);
                    throw error;
                }
            }
            
            // 解析分数
            function parseFraction(frac) {
                if (typeof frac === 'object') return frac;
                const [numerator, denominator] = frac.split('/').map(Number);
                return { numerator, denominator };
            }
            
            // 分数加法
            function addFractions(frac1, frac2) {
                if (typeof frac1 === 'number') frac1 = { numerator: frac1, denominator: 1 };
                if (typeof frac2 === 'number') frac2 = { numerator: frac2, denominator: 1 };
                
                const numerator = frac1.numerator * frac2.denominator + frac2.numerator * frac1.denominator;
                const denominator = frac1.denominator * frac2.denominator;
                
                return simplifyFraction(numerator, denominator);
            }
            
            // 分数减法
            function subtractFractions(frac1, frac2) {
                if (typeof frac1 === 'number') frac1 = { numerator: frac1, denominator: 1 };
                if (typeof frac2 === 'number') frac2 = { numerator: frac2, denominator: 1 };
                
                const numerator = frac1.numerator * frac2.denominator - frac2.numerator * frac1.denominator;
                const denominator = frac1.denominator * frac2.denominator;
                
                // 如果结果为负数，交换分数位置重新计算
                if (numerator < 0) {
                    return subtractFractions(frac2, frac1);
                }
                
                return simplifyFraction(numerator, denominator);
            }
            
            // 分数乘法
            function multiplyFractions(frac1, frac2) {
                if (typeof frac1 === 'number') frac1 = { numerator: frac1, denominator: 1 };
                if (typeof frac2 === 'number') frac2 = { numerator: frac2, denominator: 1 };
                
                const numerator = frac1.numerator * frac2.numerator;
                const denominator = frac1.denominator * frac2.denominator;
                
                return simplifyFraction(numerator, denominator);
            }
            
            // 分数除法
            function divideFractions(frac1, frac2) {
                if (typeof frac1 === 'number') frac1 = { numerator: frac1, denominator: 1 };
                if (typeof frac2 === 'number') frac2 = { numerator: frac2, denominator: 1 };
                
                // 除法转换为乘法
                const numerator = frac1.numerator * frac2.denominator;
                const denominator = frac1.denominator * frac2.numerator;
                
                return simplifyFraction(numerator, denominator);
            }
            
            // 比较两个值（支持整数、小数、分数）
            function compareValues(val1, val2) {
                // 如果都是数字，直接比较
                if (typeof val1 === 'number' && typeof val2 === 'number') {
                    return val1 - val2;
                }
                
                // 如果都是字符串（分数），转换为小数比较
                if (typeof val1 === 'string' && typeof val2 === 'string') {
                    const num1 = evalFraction(val1);
                    const num2 = evalFraction(val2);
                    return num1 - num2;
                }
                
                // 混合类型，转换为数字比较
                const num1 = typeof val1 === 'number' ? val1 : evalFraction(val1);
                const num2 = typeof val2 === 'number' ? val2 : evalFraction(val2);
                return num1 - num2;
            }
            
            // 将分数字符串转换为小数
            function evalFraction(frac) {
                if (typeof frac === 'number') return frac;
                const [num, den] = frac.split('/').map(Number);
                return num / den;
            }
            
            // 简化分数
            function simplifyFraction(numerator, denominator) {
                // 求最大公约数
                const gcd = (a, b) => {
                    if (b === 0) return a;
                    return gcd(b, a % b);
                };
                
                const divisor = gcd(numerator, denominator);
                const simplifiedNum = numerator / divisor;
                const simplifiedDen = denominator / divisor;
                
                if (simplifiedDen === 1) {
                    return simplifiedNum; // 整数
                } else {
                    return `${simplifiedNum}/${simplifiedDen}`;
                }
            }
            
            // 获取最小值
            function getMinValue() {
                if (selectedType === 'integer') {
                    return parseInt(intMinInput.value);
                } else if (selectedType === 'decimal') {
                    return parseFloat(decMinInput.value);
                } else {
                    return 0; // 分数没有直接的最小值
                }
            }
            
            // 获取最大值
            function getMaxValue() {
                if (selectedType === 'integer') {
                    return parseInt(intMaxInput.value);
                } else if (selectedType === 'decimal') {
                    return parseFloat(decMaxInput.value);
                } else {
                    return Infinity; // 分数没有直接的最大值
                }
            }
            
            // 获取零值
            function getZeroValue() {
                if (selectedType === 'integer') {
                    return 0;
                } else if (selectedType === 'decimal') {
                    return 0.0;
                } else {
                    return '0/1';
                }
            }
            
            // 获取一值
            function getOneValue() {
                if (selectedType === 'integer') {
                    return 1;
                } else if (selectedType === 'decimal') {
                    return 1.0;
                } else {
                    return '1/1';
                }
            }
            
            // 计算最大可能题目数
            function calculateMaxPossibleProblems() {
                // 简化计算，返回一个足够大的数
                return 10000;
            }
            
            // 获取运算符名称
            function getOperationNames() {
                const names = {
                    '+': '加法',
                    '-': '减法',
                    '×': '乘法',
                    '÷': '除法',
                    'continuous': '连加连减',
                    'mixed': '加减混合',
                    'continuous-mul-div': '连乘连除',
                    'mixed-mul-div': '乘除混合',
                    'all-mixed': '加减乘除混合'
                };
                
                return selectedOperations.map(op => names[op]).join('、');
            }
            
            // 显示/隐藏答案
            function toggleAnswers() {
                problemsContainer.classList.toggle('answer-visible');
                
                if (problemsContainer.classList.contains('answer-visible')) {
                    toggleAnswersBtn.textContent = '隐藏答案';
                } else {
                    toggleAnswersBtn.textContent = '显示答案';
                }
            }
            
            // 显示消息
            function showMessage(text, type) {
                const messageElement = type === 'success' ? successMessage : 
                                     type === 'error' ? errorMessage : warningMessage;
                messageElement.textContent = text;
                messageElement.style.display = 'block';
                
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
            
            // 打印试卷（不带答案）
            function printQuestions() {
                problemsContainer.classList.remove('answer-visible');
                document.body.classList.remove('print-answers');
                printTitle.style.display = 'block';
                
                window.print();
                setTimeout(() => {
                    printTitle.style.display = 'none';
                }, 500);
            }
            
            // 打印答案（带答案）
            function printAnswers() {
                document.body.classList.add('print-answers');
                printTitle.style.display = 'block';
                window.print();
                setTimeout(() => {
                    printTitle.style.display = 'none';
                    document.body.classList.remove('print-answers');
                }, 500);
            }
            
            // 清空所有题目
            function clearAllProblems() {
                problemsContainer.innerHTML = '';
                problemSet.clear();
                resultArea.style.display = 'none';
                statsInfo.textContent = '';
                showMessage('已清空所有题目', 'success');
                
                // 将使用说明移回原位置
                document.querySelector('.container').insertBefore(instructions, resultArea);
            }
            
            // 事件监听
            generateBtn.addEventListener('click', generateProblems);
            toggleAnswersBtn.addEventListener('click', toggleAnswers);
            printQuestionsBtn.addEventListener('click', printQuestions);
            printAnswersBtn.addEventListener('click', printAnswers);
            clearAllBtn.addEventListener('click', clearAllProblems);
            
            // 初始化
            addInputLimits();
            updateSelectedOperations();
            updateRangeVisibility();
            initTimer();
        });
    </script>
</body>
</html>